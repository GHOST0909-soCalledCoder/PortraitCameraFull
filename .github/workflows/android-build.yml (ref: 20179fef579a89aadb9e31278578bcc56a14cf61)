name: Android CI - Build Debug APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ANDROID_API_LEVEL: "33"
      ANDROID_BUILD_TOOLS: "33.0.2"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install basic tools
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip wget git
        shell: bash

      - name: Install Android command-line tools & SDK packages
        run: |
          set -euo pipefail

          ANDROID_SDK_ROOT="${RUNNER_TOOL_CACHE}/android-sdk"
          mkdir -p "$ANDROID_SDK_ROOT"
          cd "$ANDROID_SDK_ROOT"

          # Download the command-line tools archive
          CLT_ZIP="cmdline-tools.zip"
          wget -q "https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip" -O "$CLT_ZIP"

          # Extract to a temporary folder to tolerate multiple layouts
          TMPDIR="$(mktemp -d)"
          unzip -q "$CLT_ZIP" -d "$TMPDIR"

          # Create expected structure: cmdline-tools/latest/{bin,lib,...}
          mkdir -p cmdline-tools/latest

          # Possible extraction layouts:
          # 1) $TMPDIR/cmdline-tools/** -> move contents into cmdline-tools/latest
          # 2) $TMPDIR/* (direct files) -> move into cmdline-tools/latest
          if [ -d "$TMPDIR/cmdline-tools" ]; then
            # If the archive contains a cmdline-tools folder, move its contents to latest
            mv "$TMPDIR/cmdline-tools/"* cmdline-tools/latest/ 2>/dev/null || true
          else
            # Otherwise, move everything from tmp into latest
            mv "$TMPDIR"/* cmdline-tools/latest/ 2>/dev/null || true
          fi

          # Clean up tmp
          rm -rf "$TMPDIR" "$CLT_ZIP"

          # Ensure platform-tools folder exists in SDK root (sdkmanager will install if missing)
          mkdir -p platform-tools

          # Export PATH for this step and persist values for subsequent steps
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> "$GITHUB_ENV"
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> "$GITHUB_PATH"
          echo "$ANDROID_SDK_ROOT/platform-tools" >> "$GITHUB_PATH"

          SDKMANAGER="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"

          # Diagnostics if sdkmanager missing
          if [ ! -x "$SDKMANAGER" ]; then
            echo "ERROR: sdkmanager not found or not executable at: $SDKMANAGER"
            echo "Listing SDK root tree for debugging:"
            find "$ANDROID_SDK_ROOT" -maxdepth 4 -type f -printf "%p\n" || true
            exit 1
          fi

          # Accept licenses and install required packages non-interactively
          # Use full path to sdkmanager to avoid PATH issues
          yes | "$SDKMANAGER" --sdk_root="$ANDROID_SDK_ROOT" --licenses

          "$SDKMANAGER" --sdk_root="$ANDROID_SDK_ROOT" "platform-tools" "platforms;android-${ANDROID_API_LEVEL}" "build-tools;${ANDROID_BUILD_TOOLS}"
        shell: bash

      - name: Ensure Gradle (only used if wrapper missing)
        run: |
          if [ -f "./gradlew" ]; then
            echo "Gradle wrapper found — will use ./gradlew"
            chmod +x ./gradlew
          else
            echo "No gradle wrapper found — installing gradle via apt"
            sudo apt-get update
            sudo apt-get install -y gradle
          fi
        shell: bash

      - name: Show Java & Gradle info
        run: |
          java -version
          if [ -f "./gradlew" ]; then
            ./gradlew -v
          else
            gradle -v
          fi
        shell: bash

      - name: Build Debug APK
        run: |
          if [ -f "./gradlew" ]; then
            ./gradlew clean assembleDebug --no-daemon
          else
            gradle clean assembleDebug --no-daemon
          fi
        shell: bash
        timeout-minutes: 20

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: portraitcamera-apk
          path: |
            app/build/outputs/apk/debug/*.apk
            **/build/outputs/apk/debug/*.apk
