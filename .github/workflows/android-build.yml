name: Android CI - Build Debug APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# kept minimal at top level; job-level or step-level runtime vars are used instead.
jobs:
  build:
    runs-on: ubuntu-latest

    env:
      # change these if your project needs a different SDK / build-tools
      ANDROID_API_LEVEL: "33"
      ANDROID_BUILD_TOOLS: "33.0.2"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install basic tools
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip wget git
        shell: bash

      - name: Install Android command-line tools & SDK packages
        # Use RUNNER_TOOL_CACHE which is available as an env var on the runner at runtime.
        run: |
          set -e
          # choose a path inside the runner tool cache so the runner may cache downloads between jobs
          ANDROID_SDK_ROOT="${RUNNER_TOOL_CACHE}/android-sdk"
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          cd "$ANDROID_SDK_ROOT"

          # download a stable command-line tools package (Google's filename may change over time)
          wget -q "https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip" -O cmdline-tools.zip
          unzip -q cmdline-tools.zip -d cmdline-tools || true
          mkdir -p cmdline-tools/latest
          # move into expected folder; tolerate errors if structure differs
          mv cmdline-tools/cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true

          export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH"

          # Accept licenses and install required SDK packages
          yes | sdkmanager --sdk_root="$ANDROID_SDK_ROOT" --licenses
          sdkmanager --sdk_root="$ANDROID_SDK_ROOT" "platform-tools" "platforms;android-${ANDROID_API_LEVEL}" "build-tools;${ANDROID_BUILD_TOOLS}"
          # export for following steps in this shell session
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
        shell: bash

      - name: Ensure Gradle (only used if wrapper missing)
        run: |
          if [ -f "./gradlew" ]; then
            echo "Gradle wrapper found — will use ./gradlew"
            chmod +x ./gradlew
          else
            echo "No gradle wrapper found — installing gradle via apt"
            sudo apt-get update
            sudo apt-get install -y gradle
          fi
        shell: bash

      - name: Show Java & Gradle info
        run: |
          java -version
          if [ -f "./gradlew" ]; then
            ./gradlew -v
          else
            gradle -v
          fi
        shell: bash

      - name: Build Debug APK
        run: |
          # Use the wrapper if present, otherwise system gradle
          if [ -f "./gradlew" ]; then
            ./gradlew clean assembleDebug --no-daemon
          else
            gradle clean assembleDebug --no-daemon
          fi
        shell: bash
        timeout-minutes: 20

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: portraitcamera-apk
          path: |
            app/build/outputs/apk/debug/*.apk
            **/build/outputs/apk/debug/*.apk
